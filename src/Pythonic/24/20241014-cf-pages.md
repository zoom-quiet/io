# è¿ç§» gh-pages åˆ° Cloudflare
> å¦‚ä½•å°† github å’Œ Cloudflare çš„ Pages æœåŠ¡ä¸²è”èµ·æ¥?

## background
åŸæœ‰ç¤¾åŒºå®˜ç½‘, ä½¿ç”¨ Hugo ä½œä¸º SSG ,
é€šè¿‡ GitHub Actions ä½œä¸ºéƒ¨ç½²å·¥å…·,
å‘å¸ƒåˆ° GitHub Pages ä¸­, å¹¶ç»‘å®šåŸŸå;

å¯¹åº” actions è„šæœ¬:

[duonb.org/.github/workflows/hugo.yml at 683549a6a1745686ee744c8fae2168852ae3e100 Â· duonb/duonb.org](https://github.com/duonb/duonb.org/blob/683549a6a1745686ee744c8fae2168852ae3e100/.github/workflows/hugo.yml)

éšç€è¿è¥çš„æ·±å…¥, å‘è§‰ ç›¸æ¯” GitHub(åç»­ç¼©å†™ä¸ºGH) å„ç§åˆ«æ‰­è€Œä¸”å¤šå˜çš„é…ç½®,
Cloudflare(åç»­ç¼©å†™ä¸º CF) å„ç§è‰¯å¿ƒå…è´¹èµ„æºé…å¥—é½å…¨, è€Œä¸”å…è´¹é¢åº¦ä¸å°,
å€¼å¾—è¿ç§»;

## goal

- åŸæœ‰å†…å®¹è¿è¥æµç¨‹ä¸å˜:
    - ç¼–è¾‘éšæ—¶è¿›å…¥ GH
    - åœ¨ä»“åº“ä¸­ä½¿ç”¨ `.dev` åœ¨çº¿ IDE å®Œæˆæ–‡ç« ç¼–æ’°
    - æäº¤å, ç”± Actions è‡ªåŠ¨è§¦å‘æ‰§è¡Œå®Œæˆå‘å¸ƒ
- æœ€ç»ˆé™æ€ç½‘ç«™é€šè¿‡ CF-Pages æœåŠ¡å‘å¸ƒ
    - ç›¸æ¯” GH ä»¥åŠä¸œå®¶, CF æ˜¯æ›´åŠ ä¸“ä¸šçš„ç½‘ç»œæœåŠ¡å•†

## tracing

é€šè¯»ç›¸å…³æ–‡æ¡£ä»¥åŠç½‘å‹ä»¬çš„ç»éªŒåæ˜ç¡®:

- CF-Pages å’Œ GH-Pages æœ¬è´¨ä¸Šä¸€æ ·, éƒ½æ˜¯å¾®æœåŠ¡å¹³å°
- é€šè¿‡å¯¹åº” workflow è„šæœ¬è§¦å‘ Docker æ‹‰èµ·è™šæ‹Ÿæœº, éƒ¨ç½²å¯¹åº”ç¯å¢ƒä¸­, æ‰§è¡Œçº¦å®šæŒ‡ä»¤å®Œæˆé™æ€ç½‘ç«™çš„ç¼–è¯‘ç”Ÿæˆ
- æœ€åå¤åˆ¶åˆ°å¯¹åº”å‘å¸ƒç©ºé—´, å¹¶å®‰å…¨æ¶ˆè§£æ‰æ‰€æœ‰è™šæ‹Ÿèµ„æº


...è€Œå…è´¹çš„ä¸œè¥¿, æœæ–­éƒ½æœ‰å‘

### ç›´æ¥ä¸Š CF
> æŒ‰ç…§å®˜æ–¹æ–‡æ¡£æ¥

åŸºæœ¬æµç¨‹å°±æ˜¯:

- åˆ›å»º Pages å®ä¾‹
- å¯¹æ¥ä»“åº“
- é€‰æ‹©ç¼–è¯‘æ¡†æ¶
- é…ç½®å‘å¸ƒåŸŸå
- è§¦å‘äº‹ä»¶

ç¬¬ä¸€ä¸ªå‘:

- æ ¹æœ¬æ— æ³•è¯†åˆ«è‡ªå·± GH å¸å·ä¸æ˜¯ owner çš„ä»“åº“
- åªå¥½å°†å¯¹åº”ä»“åº“ fork åˆ°ä¸€ä¸ªå³æœ‰å…¬å¼€ç»„ç»‡ä¸­
- è™½ç„¶ fork è¿‡æ¥çš„ä»“åº“æ˜¯ç§æœ‰çš„, ä½†æ˜¯, CF è‰¯å¥½è¯†åˆ«äº†

ç¬¬äºŒä¸ªå‘:

- CF Pages ä¸­, å¹¶æ²¡æœ‰ç±»ä¼¼ GH Actrions çš„çº¦å®š, æ¯”å¦‚ä» `.github/workflow` ä¸­è‡ªåŠ¨è¯†åˆ« .yaml ä½œä¸º Dockerfiles æ¥æ‰§è¡Œ
- ç•Œé¢ä¸Šåªæœ‰ç®€æ´çš„æ¡†æ¶é€‰æ‹©, ä»¥åŠæ„å»ºæˆæœå‘å¸ƒç›®å½•ä¹‹ç±»å‡ ä¸ªé€‰æ‹©

æœç„¶, åå¤å°è¯•, éƒ½åœ¨ç±»ä¼¼é”™è¯¯ä¸­å´©æºƒäº†:

```
...
Error: Exit with error code: 1
	    at ChildProcess.<anonymous> (/snapshot/dist/run-build.js)
	    at Object.onceWrapper (node:events:652:26)
	    at ChildProcess.emit (node:events:537:28)
	    at ChildProcess._handle.onexit (node:internal/child_process:291:12)
	Failed: build command exited with code: 1
	Failed: error occurred while running build command
```

çœ‹èµ·æ¥å¯¹åº” NodeJS CF è¿˜æ²¡ä»€ä¹ˆå¥½åŠæ³•è‡ªåŠ¨å¾æœ

### å¯¹æ¥åˆ° CF
> è¿›ä¸€æ­¥æŒ–æ˜æ–‡æ¡£

æ—¢ç„¶ CF æœ¬èº«çš„ Pages æ„å»ºç¯å¢ƒä¸å¦‚ GH çš„,
é‚£ä¹ˆ, æ˜¯å¦èƒ½åœ¨ GH Actions ä¸­å®Œæˆæ„å»º,
åªæ˜¯å°†æˆæœè¾“å‡ºåˆ° CF Pages ç©ºé—´ä¸­, è€Œä¸æ˜¯åŸæœ‰çš„ GH Pages ?

ç­”æ¡ˆæ˜¯è‚¯å®šçš„, è™½ç„¶é…ç½®æ¯”è¾ƒå¤æ‚:

æ ¹æ®ç›¸å…³æ–‡æ¡£: 

- åœ¨ CF ä¸­åˆ›å»ºåº”ç”¨ token
- ä» CF ä¸­æ‹¿åˆ°å¯¹åº”å…³é”® ID
- å» GH é…ç½®ç¯å¢ƒå˜é‡, æ¥ä½¿ç”¨æˆæƒ token
- å†å¢è¡¥ Actions è„šæœ¬, æ”¹å˜æœ€åçš„ `pages-action` ç›®æ ‡

å‚è€ƒ: [upd4cloudflare Â· duonb/duonb.org@47ef95d](https://github.com/duonb/duonb.org/commit/47ef95d0255111606b975860850d9798b21f941f)

å¯æƒœ, ä¾ç„¶æœ‰ç›¸ä¼¼çš„é”™è¯¯,
è€Œä¸” CF Pages æ–‡æ¡£ä¹Ÿä¸å°‘,
ç»§ç»­æŒ–æ˜è¿›å…¥æ›´å¤šç»†èŠ‚æ¥è§£å†³é—®é¢˜æ˜¯å¦å€¼å¾—?


### é€šè¿‡ gh-pages åˆ†æ”¯
> æ´—äº†ä¸ªå†·æ°´æ¾¡, é‡æ–°æ‹ä¸€ä¸‹...

ä¹‹æ‰€ä»¥, å¯¹ CF Pages æœåŠ¡æœ‰ä¿¡å¿ƒ, å› ä¸ºä¹‹å‰æœ‰é¡¹ç›®,
åœ¨æœ¬åœ°ç”¨ Python å®Œæˆé™æ€ç½‘ç«™ç¼–è¯‘å, é€šè¿‡ GH ä»“åº“, 
å¯¹æ¥åˆ° CF Pages ä¸€ä¸‹å­å°±å‘å¸ƒå‡ºæ¥äº†,éå¸¸æµç•…;

æ‰€ä»¥, å˜¦ä¸æ¶‰åŠå…·ä½“çš„å¾®æœåŠ¡å™¨æ„å»ºè¿‡ç¨‹, åªæ˜¯å¯¹é™æ€ç½‘ç«™è¿›è¡Œå‘å¸ƒ CF Pages æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„.

è€Œ Hugo å·¥ç¨‹, ä¸ºäº†å•†ä¸šåŒ–ç•Œé¢, è¿˜å®‰è£…äº†å„ç§å¤æ‚çš„ NodeJS æ‹“å±•,
æ‰€ä»¥, Actions è¿‡ç¨‹æ¯”è¾ƒé•¿, åœ¨æœ¬åœ°éƒ½ä¸ä¸€å®šéƒ¨ç½²çš„å¯¹;
å¤§å®¶ä¹Ÿæ˜¯ä» Theme åŸå‹ä»“åº“æŠ„æ¥çš„ workflow è€Œå·²;

é‚£ä¹ˆ, é—®é¢˜å°±å˜æˆäº†, å¦‚ä½•å°†åŸå…ˆ GH Pages å‘å¸ƒæˆåŠŸçš„ Actions è„šæœ¬,
æ”¹é€ ä¸ºå¯ä»¥å°†ç¼–è¯‘å‡ºæ¥çš„ HTML æˆæœ, ä¸æ˜¯ç›´æ¥å‘å¸ƒåˆ° GH Pages ä¸­,
è€Œæ˜¯æ”¾åˆ°ä¸€ä¸ªå¯ä»¥å†ç”± CF Pages ä¸è¿›è¡Œä»»ä½•å…¶å®ƒå¤„ç½®, ç›´æ¥å¤åˆ¶ä½¿ç”¨çš„ç©ºé—´ä¸­å‘¢?

è¿™ç§ç©ºé—´åœ¨å“ªå„¿?

è¿™æ—¶, å°±æƒ³èµ·æ¥ GH Pages å½“åˆæ²¡æœ‰ Actions æœºåˆ¶æ—¶,
æ˜¯çº¦å®š `gh-pages` åˆ†æ”¯çš„, 
ä¹Ÿå°±æ˜¯å°†ç¼–è¯‘çš„é™æ€ç½‘ç«™ä¸€å®šè¦æ”¾åˆ°ç‰¹æ®Šåˆ†æ”¯ä¸­,
GH åç«¯å…¶å®ƒæœåŠ¡æ‰çŸ¥é“å¦‚ä½•å¤åˆ¶å¹¶å‘å¸ƒ;

é‚£ä¹ˆ, é—®é¢˜å°±å˜æˆ, å¦‚ä½•å°† Actions è„šæœ¬è¿è¡Œæˆæœ,ç›´æ¥æ¨é€åˆ° `gh-pages` åˆ†æ”¯ä¸­?

è¿½é—®äº† GPT è·å¾—ä»¥ä¸‹ç±»ä¼¼æ­¥éª¤:

```yaml
      - name: Save generated site files
        run: mv public ../public

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Copy built site to gh-pages branch
        run: |
          rm -rf *
          mv ../public/* .

      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Deploy static site to gh-pages branch" || echo "No changes to commit"
          git push origin gh-pages
```

å“ˆ,å°±æ˜¯æ ‡å‡†çš„ git æŒ‡ä»¤, çœ‹æ¥ `runs-on: ubuntu-22.04` æ˜¯å†…ç½® git å·¥å…·çš„;
å”¯ä¸€çš„æŠ€å·§ä¸è¿‡æ˜¯:

- ä¸ºäº†åˆç†æ¯æ¬¡éƒ½æäº¤æ‰€æœ‰ç¼–è¯‘æˆæœ
- å…ˆå°†ç¼–è¯‘æˆæœç›®å½•ç§»åŠ¨åˆ°å½“å‰å·¥ä½œç›®å½•ä»¥å¤–
- ç„¶å,åˆ‡æ¢åˆ†æ”¯
- å†å°†åˆ†æ”¯ä¸­å½“å‰æ‰€æœ‰å†…å®¹åˆ é™¤
- æœ€åå°†æˆæœç›®å½•ä¸­æ‰€æœ‰å†…å®¹å¤åˆ¶å›å·¥ä½œç›®å½•(å·²ç»æ˜¯ gh-pages åˆ†æ”¯)
- å†ç”¨ git æäº¤æ¨é€å›ä»“åº“

å…ˆåœ¨ GH ä»“åº“ä¸­è§‚å¯Ÿæ–° Actions æ˜¯å¦èƒ½å®Œæˆ;

ç„¶å, å›åˆ° CF, ä¿®è®¢ Pages é…ç½®, ä¸ä½¿ç”¨ä»»ä½•ç¼–è¯‘æ¡†æ¶, ç›´æ¥å‘å¸ƒæŒ‡å®šåˆ†æ”¯çš„æ‰€æœ‰å†…å®¹;

è·å¾—å¯¹åº”æˆæœ:

- CF æ¸ é“å‘å¸ƒçš„:[DuoNB Status Update: 2022 Q2 ğŸš€ | DuoNB Foundation](https://cf.duonb.org/blog/2022/02/15/duonb-status-update-2022-q2/)
- å¯¹æ¯”åŸç‰ˆ: [DuoNB Status Update: 2022 Q2 ğŸš€ | DuoNB Foundation](https://cf.duonb.org/blog/2022/02/15/duonb-status-update-2022-q2/)



### PS:
> å°ç»“

å‰åä¸‰æ¬¡å°è¯•, åˆç®—5+å°æ—¶, å®Œæˆäº†è¿ç§»,
è™½ç„¶æœ€åé…ç½®å˜æ›´çš„ä¸å¤š,
ä½†æ˜¯, è°ƒè¯•è¿‡ç¨‹æ¯”è¾ƒå›§, å› ä¸º Actions ä¸æ˜¯ç¼–ç¨‹ç¯å¢ƒ,
è€Œæ˜¯ç±»ä¼¼ Dockerfiles çš„æ‰§è¡Œç¯å¢ƒ,
æ¯æ¬¡ä¿®æ”¹, æ— è®ºæ˜¯æ ¼å¼è¿˜æ˜¯è¡Œä¸ºé”™è¯¯, éƒ½åªèƒ½é€šè¿‡
[Workflow runs Â· duonb/duonb.org](https://github.com/duonb/duonb.org/actions)

workflow è¿è¡Œæ—¥å¿—æ¥è§‚å¯Ÿ, æ ¹æœ¬æ— æ³•å®æ—¶è§‚å¯Ÿè¿è¡ŒæœŸçš„å„ç§è¾“å‡º;

ä½†æ˜¯, Actions æ¯•ç«Ÿæ˜¯å…è´¹çš„, å†…ç½®çš„å„ç§è¡Œä¸ºä¹Ÿéå¸¸ç¨³å¥,
åœ¨ GH æµ·é‡é¡¹ç›®çš„æŒç»­ä½¿ç”¨è¿‡ç¨‹ä¸­, ç›¸æ¯”å…¶å®ƒ PaaS å¹³å°çš„ç±»ä¼¼æœåŠ¡è¦é è°±çš„å¤š;

å€¼å¾—æ·±å…¥ç†è§£å’Œåˆ©ç”¨;

å½“ç„¶,æœ€é è°±çš„è¿˜æ˜¯æ¸…æ™°çš„ç›®æ ‡å®šä¹‰, ä»¥åŠå„ç§èµ„æºé—´å…³ç³»çš„ç†è§£,
è¿™æ ·, æ‰å¯èƒ½éšæ—¶é’ˆå¯¹æ€§æå‡ºæ–¹æ¡ˆ, å¹¶è®¾è®¡å…³é”®è§‚å¯Ÿè¡Œä¸ºæ¥æ£€éªŒ;

æ€»ä¹‹, 

- GH Actions å€¼å¾—è–…
- CF Pages å€¼å¾—è–…
- ä¸¤ç§èµ„æºå…è´¹å¯¹æ¥, å˜¦é€šè¿‡ä¸€ä¸ªæ™®é€šçš„çº¦å®šåˆ†æ”¯å³å¯ ;-)

## refer.

[Cloudflare Pages documentation](https://developers.cloudflare.com/pages/)

- [Hugo | Cloudflare Pages docs](https://developers.cloudflare.com/pages/framework-guides/deploy-a-hugo-site/)
    - [Build configuration | Cloudflare Pages docs](https://developers.cloudflare.com/pages/configuration/build-configuration/)
- [Deploy Your Personal Web\-Page With Hugo, Cloudflare and GitHub 100% For Free \| HackerNoon](https://hackernoon.com/deploy-your-personal-web-page-with-hugo-cloudflare-and-github-100percent-for-free)
- [Simple Guide to Deploying Hugo Sites with GitHub Actions and Cloudflare Pages \| by Kyodo Tech \| Medium](https://medium.com/@kyodo-tech/simple-guide-to-deploying-hugo-sites-with-github-actions-and-cloudflare-pages-2a53ddfb7533)
- ...